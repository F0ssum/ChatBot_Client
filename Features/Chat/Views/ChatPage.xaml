<Page x:Class="ChatBotClient.Features.Chat.Views.ChatPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      Background="{StaticResource BackgroundBrush}">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Верхняя панель (AppBar) -->
        <DockPanel Grid.Row="0" Background="{StaticResource PrimaryBrush}" Height="56">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0">
                <TextBlock Text="Чат с ботом"
                           Foreground="White"
                           FontSize="20"
                           FontWeight="SemiBold"
                           VerticalAlignment="Center"/>
                <!-- Индикатор соединения -->
                <Ellipse Width="12" Height="12" Margin="12,0,0,0"
                         VerticalAlignment="Center"
                         Fill="{Binding IsConnected, Converter={StaticResource BoolToBrushConverter}, 
                                ConverterParameter='Green;Red'}"/>
                <TextBlock Text="{Binding ConnectionStatusText}" 
                           Foreground="White" FontSize="12" Margin="6,0,0,0"
                           VerticalAlignment="Center"/>
            </StackPanel>
            <Button Content="{materialDesign:PackIcon Kind=Cog}" 
                    Style="{StaticResource IconButtonStyle}" 
                    DockPanel.Dock="Right"
                    ToolTip="Настройки чата"
                    Command="{Binding OpenChatSettingsCommand}"
                    Margin="0,0,16,0"/>
        </DockPanel>

        <!-- История сообщений -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,8,0,8">
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Background="{Binding Author, Converter={StaticResource MessageConverter}}"
                                CornerRadius="12"
                                Margin="8"
                                Padding="10"
                                HorizontalAlignment="{Binding Author, Converter={StaticResource MessageConverter}, ConverterParameter=Alignment}">
                            <StackPanel>
                                <TextBlock Text="{Binding Text}" TextWrapping="Wrap" Style="{StaticResource BaseTextStyle}"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,4,0,0">
                                    <TextBlock Text="{Binding Timestamp, StringFormat='HH:mm'}"
                                               Style="{StaticResource BaseTextStyle}" FontSize="10"
                                               Foreground="{StaticResource DividerBrush}" Margin="0,0,8,0"/>
                                    <!-- Статус сообщения -->
                                    <TextBlock Text="{Binding StatusCode, Converter={StaticResource MessageStatusToStringConverter}}"
                                               Style="{StaticResource BaseTextStyle}" FontSize="10"
                                               Foreground="{StaticResource DividerBrush}"/>
                                </StackPanel>
                                <!-- Кнопка для упражнения -->
                                <Button Content="Попробовать упражнение" Style="{StaticResource ModernButtonStyle}"
                                        Command="{Binding DataContext.TryExerciseCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                        Visibility="{Binding Author, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Bot}"
                                        Margin="0,5,0,0"/>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Панель ввода сообщения -->
        <Border Grid.Row="2" Background="{StaticResource PaperHoverBrush}" Padding="12" CornerRadius="12" Margin="16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <!-- Кнопки вложений -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Grid.Column="0" Margin="0,0,8,0">
                    <Button Content="{materialDesign:PackIcon Kind=EmoticonOutline}" Style="{StaticResource IconButtonStyle}" 
                            ToolTip="Эмодзи" Command="{Binding AddEmojiCommand}" Margin="0,0,4,0"/>
                    <Button Content="{materialDesign:PackIcon Kind=Attachment}" Style="{StaticResource IconButtonStyle}" 
                            ToolTip="Прикрепить файл" Command="{Binding AttachFileCommand}" Margin="0,0,4,0"/>
                    <Button Content="{materialDesign:PackIcon Kind=Microphone}" Style="{StaticResource IconButtonStyle}" 
                            ToolTip="Голосовой ввод" Command="{Binding VoiceInputCommand}"/>
                </StackPanel>
                <!-- Поле ввода -->
                <TextBox Grid.Column="1"
                         Text="{Binding MessageText, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBoxStyle}"
                         AcceptsReturn="False"
                         materialDesign:HintAssist.Hint="Введите сообщение..."
                         VerticalAlignment="Center"
                         Margin="0,0,8,0"/>
                <!-- Кнопка отправки -->
                <Button Grid.Column="2"
                        Content="{materialDesign:PackIcon Kind=Send}"
                        Style="{StaticResource IconButtonStyle}"
                        Command="{Binding SendMessageCommand}"
                        ToolTip="Отправить"
                        VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</Page>